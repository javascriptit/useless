_.defineTagKeyword("required");_.defineTagKeyword("atom");_.defineKeyword("any",_.identity);
(function(){_.isMeta=function(a){return a===$any||!0===$atom.is(a)||!0===$required.is(a)};var a=function(a,b,c){var d=Tags.unwrapAll(_.filter2(a,$required.matches));a=_.nonempty(_.zip2(Tags.unwrapAll(a),b,c));if(_.isEmpty(d))return a;c=_.nonempty(_.zip2(d,b,c));return _.values2(d).length===_.values2(c).length?a:_.coerceToEmpty(b)},b=_.hyperOperator(_.binary,function(b,c,d){var h=Tags.unwrap(b);if(_.isArray(h)){if(_.isArray(c))return a(_.times(c.length,_.constant(h[0])),c,d)}else if(_.isStrictlyObject(h)&&
h["*"]){if(_.isStrictlyObject(c))return a(_.extend(_.map2(c,_.constant(h["*"])),_.omit(h,"*")),c,d)}else return a(b,c,d)}),c=function(a,b){var c=Tags.unwrap(a);return void 0===c&&void 0===b||_.isFunction(c)&&(_.isPrototypeConstructor(c)?_.isTypeOf(c,b):c(b))||typeof b===c||b===c};_.mismatches=function(a,c,d){return b(c,d,function(b,c){return a(b,c)?void 0:b})};_.omitMismatches=function(a,c,d){return b(c,d,function(b,c){return a(b,c)?c:void 0})};_.typeMismatches=_.partial(_.mismatches,c);_.omitTypeMismatches=
_.partial(_.omitMismatches,c);_.valueMismatches=_.partial(_.mismatches,function(a,b){return a===$any||b===$any||a===b});var d=function(a){if(_.isArray(a))return _.nonempty([_.reduce(_.rest(a),function(a,b){return _.undiff(a,b)},_.first(a)||void 0)]);if(_.isStrictlyObject(a)){var b=_.pairs(a),b=_.map(_.reduce(_.rest(b),function(a,b){return _.undiff(a,b)},_.first(b)||[void 0,void 0]),_.nonempty);return _.isEmpty(b)||_.isEmpty(b[1])?a:_.object([[b[0]||"*",b[1]]])}return a};_.decideType=function(a){return _.hyperOperator(_.unary,
function(a,b){return a&&a.constructor&&a.constructor.$definition?a.constructor:d(_.map2(a,b))})(a,function(a){return _.isPrototypeInstance(a)?a.constructor:_.isEmptyArray(a)?a:typeof a})}})();_.hasAsserts=!0;
_.extend(_,{tests:{},withTest:function(a,b,c){c();_.runTest(b);_.publishToTestsNamespace(a,b)},deferTest:function(a,b,c){c();_.publishToTestsNamespace(a,b)},runTest:function(a){_.isFunction(a)?a():_.each(a,function(a){a()})},publishToTestsNamespace:function(a,b){_.isArray(a)?(_.tests[a[0]]||(_.tests[a[0]]={}))[a[1]]=b:_.tests[a]=b}});$overrideUnderscore("matches",function(a){return function(b){return _.isObject(b)?a(b):function(a){return b===a}}});
_.extend(_,_.assertions={assert:function(a){var b=[].splice.call(arguments,0);1===b.length?!0!==b[0]&&_.assertionFailed({notMatching:b}):_.allEqual(b)||_.assertionFailed({notMatching:b});return!0},assertCPS:function(a,b,c){var d=b&&(_.isArray(b)?b:[b])||[];a(function(){$assert([].splice.call(arguments,0),d);if(c)return c(),!0})},assertNotCalled:function(a){a(function(){$fail})},assertEveryCalledOnce:function(a,b){return _.assertEveryCalled(_.hasTags?$once(a):(a.once=!0,a),b)},assertEveryCalled:function(a,
b){var c=_.hasTags?$untag(a):a,d=_.hasTags?$async.is(a):a.async,e=(once=_.hasTags?$once.is(a):a.once)?null:c.toString().match(/.*function[^\(]\(([^\)]+)\)/),f=once?_.times(c.length,_.constant(1)):_.map(e[1].split(","),function(a){return(a=a.trim().match(/^(.+)__(.+)$/))&&parseInt(a[2],10)||!0}),g=_.times(c.length,_.constant(!1)),e=_.times(c.length,function(a){return function(){g[a]=_.isNumber(f[a])?(g[a]||0)+1:!0;d&&_.isEqual(g,f)&&b()}});c.apply(null,e);d||(_.assert(g,f),b&&b())},assertCallOrder:function(a){var b=
0,c=_.times(a.length,function(a){return function(){arguments.callee.callIndex=b++}});a.apply(null,c);return _.assert(_.pluck(c,"callIndex"),_.times(c.length,_.identity.arity1))},assertMatches:function(a,b){try{return _.assert(_.matches.apply(null,_.rest(arguments))(a))}catch(c){throw _.isAssertionError(c)?_.extend(c,{notMatching:[a,b]}):c;}},assertNotMatches:function(a,b){try{return _.assert(!_.matches.apply(null,_.rest(arguments))(a))}catch(c){throw _.isAssertionError(c)?_.extend(c,{notMatching:[a,
b]}):c;}},assertType:function(a,b){return _.assert(_.decideType(a),b)},assertTypeMatches:function(a,b){return _.isEmpty(_.typeMismatches(b,a))?!0:_.assertionFailed({asColumns:!0,notMatching:[{value:a},{type:_.decideType(a)},{contract:b},{mismatches:void 0}]})},assertFails:function(a){return _.assertThrows.call(this,a,_.isAssertionError)},assertThrows:function(a,b){var c=void 0,d=!1;try{a.call(this)}catch(e){c=e,d=!0}_.assert.call(this,d);1<arguments.length&&_.assertMatches.call(this,c,b)},assertNotThrows:function(a){return _.assertEveryCalled(function(b){a();
b()})},assertArguments:function(a,b,c){b=(b||a.callee).toString();var d=b.match(/.*function[^\(]\(([^\)]+)\)/);if(d){a=_.asArray(a);var d=_.map(d[1].split(","),function(a){a="_"===a.trim()[0]?a.replace(/_/g," ").trim():void 0;var b=parseInt(a,10);return _.isFinite(b)?b:a}),e=_.zipWith([d,a],function(a,b){return void 0===a?!0:a===b});_.every(e)||_.assertionFailed({notMatching:_.nonempty([[c,b].join(": "),d,a])})}},fail:function(){_.assertionFailed()},fails:_.constant(function(){_.assertionFailed()}),
stub:function(){_.assertionFailed()}});_.extend(_,{assertionError:function(a){return _.extend(Error("assertion failed"),a,{assertion:!0})},assertionFailed:function(a){throw _.extend(_.assertionError(a),{stack:_.rest(Error().stack.split("\n"),3).join("\n")});},isAssertionError:function(a){return!0===a.assertion}});_.extend(_,{allEqual:function(a){return _.reduce(a,function(b,c){return b&&_.isEqual(a[0],c)},!0)}});_.each(_.keys(_.assertions),function(a){_.defineGlobalProperty("$"+a,_[a],{configurable:!0})});
(function(){_.hasUncaught=!0;var a=_.globalUncaughtExceptionHandler=function(a){var c=arguments.callee.chain;arguments.callee.chain=_.reject(c,_.property("catchesOnce"));if(c.length)for(var d=0,e=c.length;d<e;d++)try{c[d](a);break}catch(f){console.log(f);if(d===e-1)throw f.message+=" [re-thrown by a hook]",f;f&&"object"===typeof f&&(f.originalError=a);a=f}else throw a.message+=" [re-thrown by a hook]",a;};_.withUncaughtExceptionHandler=function(b,c){var d=c||_.identity;c&&(b.catchesOnce=!0);a.chain.unshift(b);
d(function(){a.chain.remove(b)})};a.chain=[];switch(Platform.engine){case "node":require("process").on("uncaughtException",a);break;case "browser":window.addEventListener("error",function(b){0>b.message.indexOf(" [re-thrown by a hook]")&&(b.error?a(b.error):a(_.extend(Error(b.message),{stub:!0,stack:"at "+b.filename+":"+b.lineno+":"+b.colno})))})}})();
(function(){if(Platform.Browser){_.hasUncaughtAsync=!0;var a=void 0,b=function(b,d){return __supressErrorReporting=function(){var e={name:name,stack:Error().stack,asyncContext:a},f=_.asArray(arguments),g=f[d];g.__uncaughtJS_wrapper=f[d]=__supressErrorReporting=function(){a=e;try{return g.apply(this,arguments)}catch(b){_.globalUncaughtExceptionHandler(_.extend(b,{asyncContext:e}))}};return b.apply(this,f)}};window.setTimeout=b(window.setTimeout,0);(function(a,b){var e=function(e){e.addEventListener=
a(e.addEventListener);e.removeEventListener=b(e.removeEventListener)};window.EventTarget?e(window.EventTarget.prototype):(e(Node.prototype),e(XMLHttpRequest.prototype))})(function(a){return b(a,1)},function(a){return function(b,e,f,g){return a.call(this,b,e.__uncaughtJS_wrapper||e,f)}})}})();_.hasReflection=!0;_.defineKeyword("callStack",function(){return CallStack.fromRawString(CallStack.currentAsRawString).offset(Platform.NodeJS?1:0)});
_.defineKeyword("currentFile",function(){return(CallStack.rawStringToArray(CallStack.currentAsRawString)[Platform.NodeJS?3:1]||{file:""}).file});_.defineKeyword("uselessPath",_.memoize(function(){return _.initial($currentFile.split("/"),Platform.NodeJS?2:1).join("/")+"/"}));_.defineKeyword("sourcePath",_.memoize(function(){var a=($uselessPath.match(/(.+)\/node_modules\/(.+)/)||[])[1];return a?a+"/":$uselessPath}));
SourceFiles=$singleton(Component,{apiConfig:{},line:function(a,b,c){SourceFiles.read(a,function(a){c((a.split("\n")[b]||"").trimmed)})},read:$memoizeCPS(function(a,b){if(0>a.indexOf("<"))try{if(Platform.NodeJS)b(require("fs").readFileSync(a,{encoding:"utf8"})||"");else{var c=new XMLHttpRequest;c.open("GET",a,!0);c.onreadystatechange=function(){4==c.readyState&&b(c.responseText)};c.send(null)}}catch(d){b("")}else b("")}),write:function(a,b,c){Platform.NodeJS?this.read(a,function(d){var e=require("fs"),
f={encoding:"utf8"};try{e.mkdirSync(a+".backups")}catch(g){}e.writeFileSync(a+".backups/"+Date.now(),d,f);e.writeFileSync(a,b,f);c()}):API.post("source/"+a,_.extend2({},this.apiConfig,{what:{text:b},failure:Panic,success:function(){log.ok(a,"\u2014 successfully saved");c&&c()}}))}});_.readSourceLine=SourceFiles.line;_.readSource=SourceFiles.read;_.writeSource=SourceFiles.write;
CallStack=$extends(Array,{current:$static($property(function(){return CallStack.fromRawString(CallStack.currentAsRawString).offset(1)})),fromError:$static(function(a){return a&&a.parsedStack?CallStack.fromParsedArray(a.parsedStack).offset(a.stackOffset||0):a&&a.stack?CallStack.fromRawString(a.stack).offset(a.stackOffset||0):CallStack.fromParsedArray([])}),fromErrorWithAsync:$static(function(a){var b=CallStack.fromError(a);for(a=a.asyncContext;a;)b=b.concat(CallStack.fromRawString(a.stack)),a=a.asyncContext;
return b.mergeDuplicateLines}),locationEquals:$static(function(a,b){return a.file===b.file&&a.line===b.line&&a.column===b.column}),safeLocation:function(a){return this[a]||{callee:"",calleeShort:"",file:"",fileName:"",fileShort:"",thirdParty:!1,source:"??? WRONG LOCATION ???",sourceReady:_.barrier("??? WRONG LOCATION ???")}},mergeDuplicateLines:$property(function(){return CallStack.fromParsedArray(_.map(_.partition2(this,function(a){return a.file+a.line}),function(a){return _.reduce(_.rest(a),function(a,
c){a.callee=(a.callee||"<anonymous>")+" \u2192 "+(c.callee||"<anonymous>");a.calleeShort=(a.calleeShort||"<anonymous>")+" \u2192 "+(c.calleeShort||"<anonymous>");return a},_.clone(a[0]))}))}),clean:$property(function(){return this.mergeDuplicateLines.reject(_.property("thirdParty"))}),asArray:$property(function(){return _.asArray(this)}),offset:function(a){return a&&CallStack.fromParsedArray(_.rest(this,a))||this},initial:function(a){return a&&CallStack.fromParsedArray(_.initial(this,a))||this},concat:function(a){return CallStack.fromParsedArray(this.asArray.concat(a.asArray))},
filter:function(a){return CallStack.fromParsedArray(_.filter(this,a))},reject:function(a){return CallStack.fromParsedArray(_.reject(this,a))},reversed:$property(function(){return CallStack.fromParsedArray(_.reversed(this))}),sourcesReady:function(a){return _.allTriggered(_.pluck(this,"sourceReady"),a)},constructor:function(a){Array.prototype.constructor.call(this);_.each(a,function(a){a.sourceReady||(a.sourceReady=_.barrier(),SourceFiles.line((a.remote?"api/source/":"")+a.file,a.line-1,function(c){a.sourceReady(a.source=
c)}));this.push(a)},this)},fromParsedArray:$static(function(a){return new CallStack(a)}),currentAsRawString:$static($property(function(){var a=Platform.Browser?3:2;return _.rest((Error().stack||"").split("\n"),a).join("\n")})),shortenPath:$static(function(a){var b=a.replace($uselessPath,"").replace($sourcePath,"");return b!==a?b:a.split("/").last}),isThirdParty:$static(_.bindable(function(a){var b=a.replace($sourcePath,"");return Platform.NodeJS&&"/"!==a[0]||0<=b.indexOf("/node_modules/")||0<=a.indexOf("/node_modules/")&&
!b||0<=b.indexOf("underscore")||0<=b.indexOf("jquery")})),fromRawString:$static(_.sequence(function(a){return CallStack.rawStringToArray(a)},function(a){return _.map(a,function(a){return _.extend(a,{calleeShort:_.last(a.callee.split(".")),fileName:_.last(a.file.split("/")),fileShort:CallStack.shortenPath(a.file),thirdParty:CallStack.isThirdParty(a.file)&&!a.index})})},function(a){return CallStack.fromParsedArray(a)})),rawStringToArray:$static(function(a){a=(a||"").split("\n");return _.filter2(a,function(a){a=
a.trimmed;var c,d=[],e=!1,d=d=void 0;if((d=a.match(/at (.+) \((.+)\)/))||(d=a.match(/(.*)@(.*)/)))c=d[1],e="native"===d[2],d=_.rest(d[2].match(/(.*):(.+):(.+)/)||[]);else if(d=a.match(/^(at\s+)*(.+):([0-9]+):([0-9]+)/))d=_.rest(d,2);else return!1;return 0<=(c||"").indexOf("__supressErrorReporting")?!1:{beforeParse:a,callee:c||"",index:Platform.Browser&&d[0]===window.location.href,"native":e,file:d[0]||"",line:(d[1]||"").integerValue,column:(d[2]||"").integerValue}})})});
$prototype.macro(function(a,b){var c=CallStack.currentAsRawString;a.$meta||(a.$meta=$static(_.cps.memoize(function(a){_.cps.find(CallStack.fromRawString(c).reversed,function(a,b){a.sourceReady(function(c){c=(c||"").match(/([A-z]+)\s*=\s*\$(prototype|singleton|component|extends|trait|aspect)/);b(c&&{name:c[1],type:c[2],file:a.fileShort}||!1)})},function(b){a(b||{})})})));return a});_.hasLog=!0;
_.extend(log=function(){return log.write.apply(this,arguments)},{Color:$prototype(),Config:$prototype(),cleanArgs:function(a){return _.reject(a,_.or(log.Color.isTypeOf,log.Config.isTypeOf))},read:function(a,b){return _.find(b,a.isTypeOf)||new a({})},modify:function(a,b,c){return _.reject(b,a.isTypeOf).concat(c(log.read(a,b)))}});
_.extend(log,{config:function(a){return new log.Config(a)},indent:function(a){return log.config({indent:a})},color:{red:new log.Color({shell:"\u001b[31m",css:"crimson"}),blue:new log.Color({shell:"\u001b[36m",css:"royalblue"}),orange:new log.Color({shell:"\u001b[33m",css:"saddlebrown"}),green:new log.Color({shell:"\u001b[32m",css:"forestgreen"})},readColor:log.read.partial(log.Color),readConfig:log.read.partial(log.Config),modifyColor:log.modify.partial(log.Color),modifyConfig:log.modify.partial(log.Config),
boldLine:"======================================",line:"--------------------------------------",thinLine:"......................................",withWriteBackend:$scope(function(a,b,c,d){var e=log.writeBackend.value;log.writeBackend.value=b;c(function(b){a(function(){log.writeBackend.value=e;b&&b();d&&d()})})}),writeUsingDefaultBackend:function(){var a=arguments;log.withWriteBackend(log.impl.defaultWriteBackend,function(b){log.write.apply(null,a);b()})},writeBackend:function(){return arguments.callee.value||
log.impl.defaultWriteBackend},impl:{write:function(a){return $restArg(function(){var b=log.writeBackend(),c=_.asArray(arguments),d=log.cleanArgs(c),e=_.extend({indent:0},a,log.readConfig(c)),f=Platform.NodeJS?1:3,g=(b.indent||0)+e.indent,h=log.impl.stringifyArguments(d,e),g=_.times(g,_.constant("\t")).join(""),h=h.reversed.match(/(\n*)([^]*)/),f=e.location&&log.impl.location(e.where||$callStack[f+(e.stackOffset||0)])||"",c={color:e.color||log.readColor(c),indentation:g,indentedText:h[2].reversed.split("\n").map(_.prepends(g)).join("\n"),
trailNewlines:h[1],codeLocation:f,args:c,config:e};b(c);return d[0]})},defaultWriteBackend:function(a){var b=a.color,c=a.indentedText,d=a.codeLocation;a=a.trailNewlines;(b=b&&(Platform.NodeJS?b.shell:b.css))?Platform.NodeJS?console.log(b+c+"\u001b[0m",d,a):(c=c.split("\n"),c=[_.first(c)||""].concat(_.rest(c).map(_.prepends(" "))),console.log("%c"+c.join("\n"),"color: "+b,d,a)):console.log(c,d,a)},location:function(a){return _.quoteWith("()",_.nonempty([a.calleeShort,a.fileName+":"+a.line]).join(" @ "))},
stringifyArguments:function(a,b){return _.map(a,log.impl.stringify.tails2(b)).join(" ")},stringify:function(a,b){b=b||{};if(_.isTypeOf(Error,a)){var c=log.impl.stringifyError(a);return a.originalError?c+"\n\n"+log.impl.stringify(a.originalError):c}return _.isTypeOf(CallStack,a)?log.impl.stringifyCallStack(a):"object"===typeof a?_.isArray(a)&&1<a.length&&_.isObject(a[0])&&b.table?log.asTable(a):_.stringify(a,b):"string"===typeof a?a:_.stringify(a)},stringifyError:function(a){try{var b=CallStack.fromErrorWithAsync(a).clean.offset(a.stackOffset||
0);return"[EXCEPTION] "+(a.message||"").replace(/\r|\n/g,"").trimmed.first(120)+"\n\n"+log.impl.stringifyCallStack(b)+"\n"}catch(c){return"YO DAWG I HEARD YOU LIKE EXCEPTIONS... SO WE THREW EXCEPTION WHILE PRINTING YOUR EXCEPTION:\n\n"+c.stack+"\n\nORIGINAL EXCEPTION:\n\n"+a.stack+"\n\n"}},stringifyCallStack:function(a){return log.columns(a.map(function(a){return["\tat "+a.calleeShort.first(30),_.nonempty([a.fileShort,":",a.line]).join(""),(a.source||"").first(80)]})).join("\n")}}});
(function(){var a=log.impl.write;_.extend(log,log.printAPI=_.object(_.concat([["newline",a().$("")],["write",a()]],_.flat(_.map(["red failure error e","blue info i","orange warning warn w","green success ok g"],_.splitsWith(" ").then(_.mapsWith(function(b,c,d){return[b,a({location:0!==c,color:log.color[d.first]})]})))))))})();log.writes=_.higherOrder(log.write);logs=_.mapWith(_.higherOrder,log.printAPI);log.pretty=_.map2(log.printAPI,_.partial.tails2(log.config({pretty:!0})));
_.extend(log,{asTable:function(a){var b=a.map(_.keys.arity1).reduce(_.union.arity2,[]);a=log.columns([b].concat(_.map(a,function(a){return b.map(_.propertyOf(a))})),{maxTotalWidth:120,minColumnWidths:b.map(_.property("length"))});return[a[0],log.thinLine[0].repeats(a[0].length),_.rest(a)].flat.join("\n")},columns:function(a,b){if(0===a.length)return[];var c=a.map(_.map.tails2(function(a){return _.asString(a).split("\n")[0]})),d=c.map(_.map.tails2(_.property("length"))),e=d.zip(_.largest),f=b||{minColumnWidths:e,
maxTotalWidth:0},g=_.reduce(e,_.sum,0),h=_.map(e,_.muls(1/g)),k=Math.max(0,g-f.maxTotalWidth),l=_.map(e,function(a,b){return Math.max(f.minColumnWidths[b],Math.floor(a-k*h[b]))}),d=d.map(function(a){return[l,a].zip(_.subtract)});return[c,d].zip(_.zap.tails(function(a,b){return 0<=b?a+" ".repeats(b):_.initial(a,-b).join("")}).then(_.joinsWith("  ")))}});Platform.NodeJS&&(module.exports=log);_.defineTagKeyword("shouldFail");_.defineTagKeyword("async");_.defineTagKeyword("assertion");
Testosterone=$singleton({prototypeTests:[],isRunning:$property(function(){return void 0!==this.currentAssertion}),constructor:function(){_.each(_.assertions,function(a,b){this.defineAssertion(b,"assertFails"===b?$shouldFail(function(a){a.call(this)}):a)},this);(function(a){$prototype.macro("$test",a);$prototype.macro("$tests",a)})(this.$(function(a,b,c){this.prototypeTests.push({readPrototypeMeta:Tags.unwrap(a.$meta),tests:b});a[c]=$static($property($constant(a[c])));return a}));this.run=this.$(this.run)},
run:_.interlocked(function(a,b,c){var d=3===arguments.length?c:_.identity,e=this.runConfig=_.extend({silent:!0,verbose:!1,timeout:2E3,testStarted:function(a){},testComplete:function(a){}},b),f=_.isArray(e.suites||e.tests),g=_.map(e.suites||[],this.$(function(a,b){return this.testSuite(f?a.name:b,f?a.tests:a,e.context)}));(!1===e.codebase?_.cps.constant([]):this.$(this.collectPrototypeTests))(this.$(function(b){var c=!1===e.codebase?[]:this.collectTests();b=_.flatten(_.pluck(c.concat(g).concat(b),
"tests"));b=_.filter(b,e.shouldRun||_.constant(!0));this.runningTests=_.map(b,function(a,b){return _.extend(a,{indent:e.indent,index:b})});_.cps.each(this.runningTests,this.$(this.runTest),this.$(function(){_.assert(!0!==e.done);e.done=!0;this.printLog(e);this.failedTests=_.filter(this.runningTests,_.property("failed"));this.failed=0<this.failedTests.length;d(!this.failed);a()}))}))}),onException:function(a){if(this.currentAssertion)this.currentAssertion.onException(a);else throw a;},defineAssertions:function(a){_.each(a,
function(a,c){this.defineAssertion(c,a)},this)},runTest:function(a,b,c){var d=this.runConfig;d.testStarted(a);a.verbose=d.verbose;a.timeout=d.timeout;a.startTime=Date.now();a.run(function(){d.testComplete(a);a.time=Date.now()-a.startTime;c()})},collectTests:function(){return _.map(_.tests,this.$(function(a,b){return this.testSuite(b,a)}))},collectPrototypeTests:function(a){_.cps.map(this.prototypeTests,this.$(function(a,c){a.readPrototypeMeta(this.$(function(d){c(this.testSuite(d.name,a.tests))}))}),
a)},testSuite:function(a,b,c){return{name:a||"",tests:_(_.pairs("function"===typeof b&&_.object([[a,b]])||b)).map(function(b){var e=new Test({name:b[0],routine:b[1],suite:a,context:c});e.complete(function(){(e.hasLog=0<e.logCalls.length)||(e.failed?log.red("FAIL"):e.verbose&&log.green("PASS"))});return e})}},defineAssertion:function(a,b){var c=this;_.deleteKeyword(a);_.defineKeyword(a,Tags.modifySubject(b,function(d){return _.withSameArgs(d,function(){var e=$callStack.safeLocation(1);return c.currentAssertion?
c.currentAssertion.babyAssertion(a,b,d,arguments,e):d.apply(c,arguments)})}))},printLog:function(a){if(!a.supressLog){var b=_.filter(this.runningTests,function(b){return b.failed||!a.silent&&b.hasLog}),c=_.filter(this.runningTests,_.property("failed"));_.invoke(a.verbose?this.runningTests:b,"printLog");c.length?log.orange("\n"+log.boldLine+"\nSOME TESTS FAILED:",_.pluck(c,"name").join(", "),"\n\n"):!0!==a.silent&&log.green("\n"+log.boldLine+"\nALL TESTS PASS\n\n")}}});
Test=$prototype({constructor:function(a){_.defaults(this,a,{name:"<< UNNAMED FOR UNKNOWN REASON >>",failed:!1,routine:void 0,verbose:!1,depth:1,indent:0,failedAssertions:[],context:this,complete:_.extend(_.barrier(),{context:this})});this.babyAssertion=_.interlocked(this.babyAssertion)},finalize:function(){this.babyAssertion.wait(this.$(function(){this.canFail&&this.failedAssertions.length&&(this.failed=!0);this.complete(!0)}))},babyAssertion:function(a,b,c,d,e,f){var g=this,h=new Test({mother:this,
name:b,shouldFail:c.$shouldFail||this.shouldFail,depth:this.depth+1,location:f,context:this.context,timeout:this.timeout/2,verbose:this.verbose,silent:this.silent,routine:Tags.modifySubject(c,function(a){return function(b){if($async.is(e[0]))_.cps.apply(a,g.context,e,function(a,c){c&&c();b()});else try{a.apply(g.context,e),b()}catch(c){h.onException(c)}}})}),k=function(){h.failed&&g.canFail&&g.failedAssertions.push(h);a()};h.run(function(){Testosterone.currentAssertion=g;h.failed||h.verbose&&h.logCalls.notEmpty?
h.location.sourceReady(function(a){log.red(a,log.config({location:h.location,where:h.location}));h.evalLogCalls();k()}):k()})},canFail:$property(function(){return!this.failed&&!this.shouldFail}),fail:function(){this.failed=!0;this.finalize()},assertionStack:$property(function(){var a=[],b=this;do a.push(b),b=b.mother;while(b);return a}),onException:function(a){if(this.canFail||this.verbose){if(_.isAssertionError(a)){if("notMatching"in a){var b=_.coerceToArray(a.notMatching);a.asColumns?log.orange(log.columns(_.map(b,
function(a){return["\u2022 "+_.keys(a)[0],_.stringify(_.values(a)[0])]})).join("\n")):_.each(b,function(a,b){log.orange(_.bullet("\u2022 ",log.impl.stringify(a)))})}}else 1<this.depth&&log.newline(),log.write(a);log.newline()}this.canFail?this.fail():this.finalize()},run:function(a){var b=Testosterone.currentAssertion=this,c=Tags.unwrap(this.routine);this.shouldFail=$shouldFail.is(this.routine);this.hasLog=this.failed=!1;this.logCalls=[];this.failureLocations={};_.withTimeout({maxTime:b.timeout,expired:function(){b.canFail&&
(log.error("TIMEOUT EXPIRED"),b.fail())}},b.complete);_.withUncaughtExceptionHandler(b.$(b.onException),b.complete);log.withWriteBackend(_.extendWith({indent:b.depth+(b.indent||0)},function(a){b.logCalls.push(a)}),function(d){b.complete(d.arity0);a&&b.complete(a);0<c.length?c.call(b.context,b.$(b.finalize)):(c.call(b.context),b.finalize())})},printLog:function(){var a=this.suite&&this.suite!==this.name&&(this.suite||"").quote("[]")||"";log.write(log.color.blue,"\n"+log.boldLine,"\n"+_.nonempty([a,
this.name]).join(" "),(this.index+" of "+Testosterone.runningTests.length).quote("()")+(this.failed?" FAILED":"")+":","\n");this.evalLogCalls()},evalLogCalls:function(){_.each(this.logCalls,log.writeBackend().arity1)}});_.defineTagKeyword("recursive");
Testosterone.ValidatesMethodContracts=$trait({$test:function(){var a=new ($component({$traits:[Testosterone.ValidatesMethodContracts],foo:function(){},bar:function(){this.bar()},baz:$recursive({max:2},function(){this.baz()}),qux:$recursive(function(){this.quxCalled||(this.quxCalled=!0,this.qux())})}));a.foo();$assertThrows(a.bar,{message:"Max recursion depth reached (0)"});$assertThrows(a.baz,{message:"Max recursion depth reached (2)"});a.qux()},beforeInit:function(){var a=function(a,c){var d=-1;
return function(){if(d>a)throw Error("Max recursion depth reached ("+a+")");var e=(++d,c.apply(this,arguments));d--;return e}};return function(){this.mapMethods(function(a){return!a||!a.$recursive||void 0!==a.$recursive.max},function(b,c,d){return a(d&&d.$recursive&&d.$recursive.max||0,b)})}}()});Platform.NodeJS&&(module.exports=Testosterone);_.measure=function(a,b){if(b){var c=_.now();a(function(){b(_.now()-c)})}else return c=_.now(),a(),_.now()-c};
_.perfTest=function(a,b){var c=_.isFunction(a)?{test:a}:a,d={};_.cps.each(c,function(a,b,c){var h=[],k=function(){for(var c=0;500>c;c++)h.push(a());console.log(b,h)};k();_.delay(function(){d[b]=_.measure(k)/500;c()},100)},function(){b(d)})};
(function(a){"undefined"===typeof UI&&(UI={});Panic=function(a,c){c=_.defaults(_.clone(c||{}),{dismiss:_.identity,raw:!1});if(null!==a){_.isTypeOf(Error,a)&&_.extend(c,_.pick(a,"retry","dismiss"));Panic.widget.append(a,c.raw);if(_.isFunction(c.retry))Panic.widget.onRetry(c.retry);if(_.isFunction(c.dismiss))Panic.widget.onClose(c.dismiss)}};Panic.init=function(){Panic._initialized||(Panic._initialized=!0,_.withUncaughtExceptionHandler(function(a){Panic(a);throw a;}))};Panic.widget=$singleton(Component,
{retryTriggered:$triggerOnce(),closeTriggered:$triggerOnce(),el:$memoized($property(function(){var b=a('<div class="panic-modal-overlay" style="z-index:5000; display:none;">').append([this.bg=a('<div class="panic-modal-overlay-background">'),this.modal=a('<div class="panic-modal">').append([this.modalBody=a('<div class="panic-modal-body">').append(this.title=a('<div class="panic-modal-title">Now panic!</div>')),a('<div class="panic-modal-footer">').append([this.btnRetry=a('<button type="button" class="panic-btn panic-btn-warning" style="display:none;">Try again</button>').touchClick(this.retry),
this.btnClose=a('<button type="button" class="panic-btn panic-btn-danger" style="display:none;">Close</button>').touchClick(this.close)])])]);b.appendTo(document.body);a(document).ready(function(){b.appendTo(document.body)});try{a(window).resize(this.layout).resize(),this.modal.enableScrollFaders({scroller:this.modalBody}),a(document).keydown(this.$(function(a){27===a.keyCode&&this.close()}))}catch(c){_.delay(function(){Panic(c)})}return b})),layout:function(){this.modal.css("max-height",a(window).height()-
100);this.modalBody.scroll()},toggleVisibility:function(a){a!==("none"!==this.el.css("display"))&&(a&&this.el.css("display",""),this.el.animateWith(a?"panic-modal-appear":"panic-modal-disappear",this.$(function(){a||this.el.css("display","none")})))},onRetry:function(a){this.retryTriggered(a);this.btnRetry.css("display","")},onClose:function(a){this.closeTriggered(a);this.btnClose.css("display","")},retry:function(){this._clean();this.closeTriggered.off();this.toggleVisibility(!1);this.retryTriggered()},
close:function(){this._clean();this.retryTriggered.off();this.toggleVisibility(!1);this.closeTriggered()},_clean:function(){this.modalBody.find(".panic-alert-error").remove();this.modalBody.scroll();this.btnRetry.css("display","none");this.btnClose.css("display","none")},append:function(b,c){var d="panic"+this.hash(b),e=a("#"+d+" .panic-alert-counter");e.length?e.text((e.text()||"1").parsedInt+1):a('<div class="panic-alert-error">').attr("id",d).append('<span class="panic-alert-counter">').append(this.print(b,
c)).insertAfter(this.el.find(".panic-modal-title"));this.toggleVisibility(!0);this.layout()},hash:function(a){return((_.isTypeOf(Error,a)?a&&a.stack:_.isTypeOf(Test,a)?a.suite+a.name:a)||"").hash},print:function(a,c){return _.isTypeOf(Error,a)?this.printError(a):_.isTypeOf(Test,a)?this.printFailedTest(a):this.printUnknownStuff(a,c)},printUnknownStuff:function(b,c){return c?b:a("<span>").text(log.impl.stringify(b))},printFailedTest:function(b){var c=a('<pre class="test-log" style="margin-top: 13px;">');
log.withWriteBackend(this.$(function(b){var e=b.args;_.isTypeOf(Error,e.first)?c.append([b.indentation,c.append(a('<span class="inline-exception">').css({color:b.color.css}).append(this.printError(e.first)))]):c.append(a("<div>").css({color:b.color.css}).html(_.escape(b.indentedText)+(b.codeLocation&&' <span class="location">'+b.codeLocation+"</span>"||"")+(b.trailNewlines||"").replace(/\n/g,"<br>")))}),function(a){b.evalLogCalls();a()});return[a('<div class="panic-alert-error-message" style="font-weight: bold;">').text(b.name).append('<span style="float:right; opacity: 0.25;">test failed</span>'),
c]},printError:function(b){var c=CallStack.fromErrorWithAsync(b);return[a('<div class="panic-alert-error-message" style="font-weight: bold;">').text(b.message).append(_.any(c,function(a,b){return(a.thirdParty||a["native"])&&0!==b})?'<a class="clean-toggle" href="javascript:{}"></a>':"").click(this.$(function(b){a(b.delegateTarget).parent().toggleClass("all").transitionend(this.$(function(){this.modalBody.scroll()}))})),a('<ul class="callstack">').append(_.map(c,this.$(function(b){var c=a('<li class="callstack-entry">').toggleClass("third-party",
b.thirdParty).toggleClass("native",b["native"]).append([a('<span class="file">').text(_.nonempty([b.index?"(index)":b.fileShort,b.line]).join(":")),a('<span class="callee">').text(b.calleeShort),a('<span class="src i-am-busy">').click(this.$(function(f){var g=a(f.delegateTarget);g.waitUntil(_.readSource.partial((b.remote?"api/source/":"")+b.file),this.$(function(f){c.is(".full")?(c.removeClass("full"),c.transitionend(function(){c.is(".full")||b.sourceReady(g.$(a.fn.text))})):(c.addClass("full"),g.html(_.map(f.split("\n"),
function(b){return a('<div class="line">').text(b)})),f=g.find(".line").eq(b.line-1).addClass("hili"),f.length&&(f=f.offset().top-g.offset().top,g.scrollTop(f-100)),_.delay(this.$(function(){var a=g.outerBBox().bottom+242-this.modalBody.outerBBox().bottom;0<a&&this.modalBody.animate({scrollTop:this.modalBody.scrollTop()+a},250)})))}))}))]);b.sourceReady(function(a){c.find(".src").removeClass("i-am-busy").text(a)});return c})))]}});a.fn.extend({enableScrollFaders:function(b){var c=b&&b.horizontal,
d,e;b=this.find(b&&b.scroller||".scroller");this.css({position:"relative"});this.append(d=a('<div class="scroll-fader scroll-fader-'+(c?"left":"top")+'"></div>')).append(e=a('<div class="scroll-fader scroll-fader-'+(c?"right":"bottom")+'"></div>'));b.scroll(function(){var b=c?a(this).scrollLeft():a(this).scrollTop(),g=c?a(this).width():a(this).height(),h=(c?this.scrollWidth:this.scrollHeight)-1;d.css({opacity:0<b?1:0});e.css({opacity:b+g<h?1:0})}).scroll();return this}})})(jQuery);
(function(a){LogOverlay=$singleton(Component,{$defaults:{opaque:!1,init:!1},init:function(){log.withWriteBackend(this.write,function(){});a(document).keydown(this.$(function(a){192===a.keyCode&&this.toggle()}))},el:$memoized($property(function(){return a('<div class="useless-log-overlay" style="display: none;">').appendTo(document.body)})),toggle:function(a){this.el.toggle(a)},write:function(b){this.toggle(!0);b.config.clear&&this.el.empty();this.el.append(a('<div class="ulo-line">').css("color",
b.color.css).append(a('<span class="ulo-line-text">').text(b.indentedText+" ")).append(a('<span class="ulo-line-where">').text(b.codeLocation+" ")).append(a('<span class="ulo-line-trail">').text(b.trailNewlines)));this.opaque||log.impl.defaultWriteBackend(b)}})})(jQuery);
(function(a){Panic.init();CallStack.isThirdParty.intercept(function(a,c){return 0<=a.indexOf("underscore")||0<=a.indexOf("jquery")||0<=a.indexOf("useless")||0<=a.indexOf("mootools")});a("head").append([a('<style type="text/css">').text("@-webkit-keyframes bombo-jumbo {\n  0%   { -webkit-transform: scale(0); }\n  80%  { -webkit-transform: scale(1.2); }\n  100% { -webkit-transform: scale(1); } }\n\n@keyframes bombo-jumbo {\n  0%   { transform: scale(0); }\n  80%  { transform: scale(1.2); }\n  100% { transform: scale(1); } }\n\n@-webkit-keyframes pulse-opacity {\n  0% { opacity: 0.5; }\n  50% { opacity: 0.25; }\n  100% { opacity: 0.5; } }\n\n@keyframes pulse-opacity {\n  0% { opacity: 0.5; }\n  50% { opacity: 0.25; }\n  100% { opacity: 0.5; } }\n\n.i-am-busy { -webkit-animation: pulse-opacity 1s ease-in infinite; animation: pulse-opacity 1s ease-in infinite; pointer-events: none; }\n\n.panic-modal .scroll-fader-top, .scroll-fader-bottom { left: 42px; right: 42px; position: absolute; height: 20px; pointer-events: none; }\n.panic-modal .scroll-fader-top { top: 36px; background: -webkit-linear-gradient(bottom, rgba(255,255,255,0), rgba(255,255,255,1)); }\n.panic-modal .scroll-fader-bottom { bottom: 128px; background: -webkit-linear-gradient(top, rgba(255,255,255,0), rgba(255,255,255,1)); }\n\n.panic-modal-appear {\n  -webkit-animation: bombo-jumbo 0.25s cubic-bezier(1,.03,.48,1);\n  animation: bombo-jumbo 0.25s cubic-bezier(1,.03,.48,1); }\n\n.panic-modal-disappear {\n  -webkit-animation: bombo-jumbo 0.25s cubic-bezier(1,.03,.48,1); -webkit-animation-direction: reverse;\n  animation: bombo-jumbo 0.25s cubic-bezier(1,.03,.48,1); animation-direction: reverse; }\n\n.panic-modal-overlay {\n          display: -ms-flexbox; display: -moz-flex; display: -webkit-flex; display: flex;\n          -ms-flex-direction: column; -moz-flex-direction: column; -webkit-flex-direction: column; flex-direction: column;\n          -ms-align-items: center; -moz-align-items: center; -webkit-align-items: center; align-items: center;\n          -ms-flex-pack: center; -ms-align-content: center; -moz-align-content: center; -webkit-align-content: center; align-content: center;\n          -ms-justify-content: center; -moz-justify-content: center; -webkit-justify-content: center; justify-content: center;\n          position: fixed; left: 0; right: 0; top: 0; bottom: 0;\n          font-family: Helvetica, sans-serif; }\n\n.panic-modal-overlay-background { z-index: 1; position: absolute; left: 0; right: 0; top: 0; bottom: 0; background: white; opacity: 0.75; }\n\n.panic-modal { box-sizing: border-box; display: -webkit-flex; display: flex; position: relative; border-radius: 4px; z-index: 2; width: 600px; background: white; padding: 36px 42px 128px 42px; box-shadow: 0px 30px 80px rgba(0,0,0,0.25), 0 1px 2px rgba(0,0,0,0.15); }\n.panic-alert-counter { float: left; background: #904C34; border-radius: 8px; width: 17px; height: 17px; display: inline-block; text-align: center; line-height: 16px; margin-right: 1em; margin-left: -2px; font-size: 10px; color: white; font-weight: bold; }\n.panic-alert-counter:empty { display: none; }\n\n.panic-modal-title { color: black; font-weight: 300; font-size: 30px; opacity: 0.5; margin-bottom: 1em; }\n.panic-modal-body { overflow-y: auto; width: 100%; }\n.panic-modal-footer { text-align: right; position: absolute; left: 0; right: 0; bottom: 0; padding: 42px; }\n\n.panic-btn { margin-left: 1em; font-weight: 300; font-family: Helvetica, sans-serif; -webkit-user-select: none; user-select: none; cursor: pointer; display: inline-block; padding: 1em 1.5em; border-radius: 4px; font-size: 14px; border: 1px solid black; color: white; }\n.panic-btn:focus { outline: none; }\n.panic-btn:focus { box-shadow: inset 0px 2px 10px rgba(0,0,0,0.25); }\n\n.panic-btn-danger       { background-color: #d9534f; border-color: #d43f3a; }\n.panic-btn-danger:hover { background-color: #c9302c; border-color: #ac2925; }\n\n.panic-btn-warning       { background-color: #f0ad4e; border-color: #eea236; }\n.panic-btn-warning:hover { background-color: #ec971f; border-color: #d58512; }\n\n.panic-alert-error { border-radius: 4px; background: #FFE8E2; color: #904C34; padding: 1em 1.2em 1.2em 1.2em; margin-bottom: 1em; font-size: 14px; }\n\n.panic-alert-error { position: relative; text-shadow: 0px 1px 0px rgba(255,255,255,0.25); }\n\n.panic-alert-error .clean-toggle { height: 2em; text-decoration: none; font-weight: 300; position: absolute; color: black; opacity: 0.25; right: 1.2em; left: 0; top: 1em; display: block; text-align: right; }\n.panic-alert-error .clean-toggle:hover { text-decoration: underline; }\n.panic-alert-error .clean-toggle:before,\n.panic-alert-error .clean-toggle:after { position: absolute; right: 0; transition: all 0.25s ease-in-out; display: inline-block; overflow: hidden; }\n.panic-alert-error .clean-toggle:before { -webkit-transform-origin: center left; transform-origin: center left; content: 'more'; }\n.panic-alert-error .clean-toggle:after { -webkit-transform-origin: center left; transform-origin: center right; content: 'less'; }\n.panic-alert-error.all .clean-toggle:before { -webkit-transform: scale(0); transform: scale(0); }\n.panic-alert-error:not(.all) .clean-toggle:after { -webkit-transform: scale(0); transform: scale(0); }\n\n.panic-alert-error:last-child { margin-bottom: 0; }\n\n.panic-alert-error-message { line-height: 1.2em; position: relative; }\n\n.panic-alert-error .callstack { font-size: 12px; margin: 2em 0 0.1em 0; font-family: Menlo, monospace; padding: 0; }\n\n.panic-alert-error .callstack-entry { white-space: nowrap; opacity: 1; transition: all 0.25s ease-in-out; margin-top: 10px; list-style-type: none; max-height: 38px; overflow: hidden; }\n.panic-alert-error .callstack-entry .file { }\n.panic-alert-error .callstack-entry .file:not(:empty) + .callee:not(:empty):before { content: ' \u2192 '; }\n\n.panic-alert-error:not(.all) .callstack-entry.third-party:not(:first-child),\n.panic-alert-error:not(.all) .callstack-entry.native:not(:first-child) { max-height: 0; margin-top: 0; opacity: 0; }\n\n.panic-alert-error .callstack-entry,\n.panic-alert-error .callstack-entry * { line-height: initial; }\n.panic-alert-error .callstack-entry .src { overflow: hidden; transition: height 0.25s ease-in-out; height: 22px; border-radius: 2px; cursor: pointer; margin-top: 2px; white-space: pre; display: block; color: black; background: rgba(255,255,255,0.75); padding: 4px; }\n.panic-alert-error .callstack-entry.full .src { font-size: 12px; height: 200px; overflow: scroll; }\n.panic-alert-error .callstack-entry.full .src .line.hili { background: yellow; }\n.panic-alert-error .callstack-entry.full { max-height: 220px; }\n\n.panic-alert-error .callstack-entry .src.i-am-busy { background: white; }\n\n.panic-alert-error .callstack-entry        .src:empty                  { pointer-events: none; }\n.panic-alert-error .callstack-entry        .src:empty:before           { content: '<< SOURCE NOT LOADED >>'; color: rgba(0,0,0,0.25); }\n.panic-alert-error .callstack-entry.native .src:empty:before           { content: '<< NATIVE CODE >>'; color: rgba(0,0,0,0.25); }\n.panic-alert-error .callstack-entry        .src.i-am-busy:empty:before { content: '<< SOURCE LOADING >>'; color: rgba(0,0,0,0.5); }\n\n.panic-alert-error .callstack-entry .line:after { content: ' '; }\n\n.panic-alert-error pre { font-family: Menlo, monospace; overflow: scroll; border-radius: 2px; white-space: pre; color: black; background: rgba(255,255,255,0.75); padding: 4px; margin: 0; font-size: 11px; }\n\n.panic-aler-error .inline-exception { position: relative; }\n\n\n"),a('<style type="text/css">').text(".useless-log-overlay { position: fixed; bottom: 10px; left: 10px; right: 10px; background: rgba(255,255,255,0.75); z-index: 5000;\n\t\t\t\t\t   white-space: pre;\n\t\t\t\t\t   font-family: Menlo, monospace;\n\t\t\t\t\t   font-size: 11px;\n\t\t\t\t\t   pointer-events: none;\n\t\t\t\t\t   text-shadow: 1px 1px 0px rgba(0,0,0,0.07); }\n\n.ulo-line \t\t{ white-space: pre; word-wrap: normal; }\n.ulo-line-where { color: black; opacity: 0.25; }")])})(jQuery);
